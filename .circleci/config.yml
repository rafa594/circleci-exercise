version: 2
jobs:
    dockerbuild:
        machine: true
        steps:
            - checkout
            - run: |
                docker build -t rafa-nginx-image:$CIRCLE_SHA1 .
                mkdir -p ~/.aws
                echo "[default]
                aws_access_key_id = $aws_access_key_id
                aws_secret_access_key = $aws_secret_access_key
                aws_session_token = $aws_session_token
                " > ~/.aws/credentials
                curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                unzip awscliv2.zip
                sudo ./aws/install
                aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin $aws_ecr_image
                docker tag rafa-nginx-image:$CIRCLE_SHA1 $aws_ecr_image:$CIRCLE_SHA1
                docker push $aws_ecr_image:$CIRCLE_SHA1


    taskdefinitionUpdate:
        machine: true
        steps:
            - checkout
            - run: |
                mkdir -p ~/.aws
                echo "[default]
                aws_access_key_id = $aws_access_key_id
                aws_secret_access_key = $aws_secret_access_key
                aws_session_token = $aws_session_token
                " > ~/.aws/credentials

                sed 's#IMAGENAME#'"$aws_ecr_image:$CIRCLE_SHA1"'#' ./taskdefinition.json > td.json
                echo "sed ok"
                aws ecs register-task-definition --cli-input-json file://$HOME/project/td.json > info.json
                echo "register ok"
                cat info.json
                arn_taskdefinition=$(cat info.json | python -c 'import sys, json; print json.load(sys.stdin)["ContainerDefinition"]["Name"]')
                echo $arn_taskdefinition
                aws ecs update-service --service rafa-service --task-definition $arn_taskdefinition
                echo "all ok"



                
    
            
                

workflows:
    version: 2
    build-workflow:
        jobs:
            - dockerbuild:
                filters:
                    branches:
                        only: master
                context: aws_credentials
                
            - taskdefinitionUpdate:
                filters:
                    branches:
                        only: master
                context: aws_credentials
                requires:
                    - dockerbuild
